#!/bin/bash

echo "=== Testing Frontend to Backend Connection ==="
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "‚ùå Error: Docker is not running or not available."
  echo "Please start Docker and try again."
  exit 1
fi

echo "üîç Testing Docker Compose..."
if ! docker-compose --version > /dev/null 2>&1; then
  echo "‚ùå Error: Docker Compose is not installed or not available."
  exit 1
fi
echo "‚úÖ Docker Compose is available."

echo ""
echo "üöÄ Starting services with Docker Compose..."
docker-compose up -d

echo ""
echo "‚è≥ Waiting for services to start up..."
sleep 10

echo ""
echo "üîç Testing Backend API health..."
BACKEND_HEALTH=$(curl -s http://localhost:8000/health || echo "Failed to connect")

if [[ "$BACKEND_HEALTH" == *"status"*"ok"* ]]; then
  echo "‚úÖ Backend API is healthy!"
else
  echo "‚ùå Backend API health check failed: $BACKEND_HEALTH"
  echo "Try accessing http://localhost:8000/health in your browser"
fi

echo ""
echo "üîç Testing Frontend availability..."
FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "Failed to connect")

if [[ "$FRONTEND_STATUS" == "200" ]]; then
  echo "‚úÖ Frontend is available!"
else
  echo "‚ùå Frontend check failed with status: $FRONTEND_STATUS"
  echo "This could be normal for Next.js which might return a different status"
  echo "Try accessing http://localhost:3000 in your browser"
fi

echo ""
echo "=== Connection Test Complete ==="
echo ""
echo "Access the connection test page at: http://localhost:3000/test-connection"
echo ""
echo "When finished testing, you can stop the services with:"
echo "  docker-compose down"
echo ""
echo "Happy testing! üéâ" 